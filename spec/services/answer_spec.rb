require "openai"
require "csv"

require './app/services/answer'

RSpec.describe Answer do
    let(:question_embedding) do
        CSV.read('spec/fixtures/what-is-the-real-frank-zappa-book-about-question-embedding.csv').last.map(&method(:Float))
    end
    let(:expected_answer) do
        '"The Real Frank Zappa Book" is an autobiography that covers my life from childhood to the present day. It includes stories about my family, my musical career, my views on politics and culture, and my thoughts on the music industry. It also includes a selection of epigraphs from various authors, as well as a few of my own drawings.'
    end
    let(:open_ai_client) do
        double(
            OpenAI::Client,
            :completions => {
                'choices' => [
                    {
                        'text' => expected_answer,
                    },
                ],
            },
            :embeddings => {
                'data' => [
                    {
                        'embedding' => question_embedding,
                    },
                ],
            }
        )
    end

    it "fixme" do
        answer, context = Answer.answer_question('What is "the Real Frank Zappa Book" about?', client: open_ai_client)

        expect(open_ai_client).to have_received(:embeddings).with(
            :parameters => {
                :input => "What is \"the Real Frank Zappa Book\" about?",
                :model => "text-search-curie-query-001",
            }
        )

        expect(open_ai_client).to have_received(:completions).with(
            :parameters => {
                :max_tokens => 150,
                :model => "text-davinci-003",
                :prompt => "Frank Zappa was an American musician, composer, and bandleader. His work is characterized by nonconformity, free-form improvisation, sound experimentation, musical virtuosity and satire of American culture.\nThese are questions and answers by him. Please keep your answers to three sentences maximum, and speak in complete sentences. Stop speaking once your point is made.\n\nContext that may be useful:\n\n* FR / EN The Real Frank Zappa Book by Frank Zappa with Peter Occhiogrosso eVersion 3.0 - click for copyright info and scan notes THIS BOOK IS DEDICATED TO GAIL, THE KIDS, STEPHEN HAWKINGAND KO-KO. F.Z. August 23, 1988 06:39:37 Contents INTRODUCTION -- Book? What Book? 1 How WeirdAm I,Anyway? 2 There Goes the Neighborhood 3AnAlternative to College 4Are We Having a Good Time Yet? 5 The Log Cabin\n* of manufacturing and deploying \"ethnic chemical weapons\" -- designed to kill people from speciﬁc ethnic backgrounds. On page 241 you will ﬁnd an extract from a 1969 Senate appropriations hearing, with testimony (speaker unidentiﬁed) regarding the development of a new class of biological weapons (note the plural) which would be \"refractory\" to the human immunological system. Whose testimony was this? Was he asking for money to build a few of these diseases? What senators heard this testimony?Are they still in ofﬁce? Did they appropriate any funds? If so, who got them? What did they eventually spend them on? The book doesn't say, but presumably some answers might be found in The Congressional Record. (I also recommend The Mind of the Bible Believer by Edmund Cohen, PhD., Salvation for Sale by Gerard Thomas Straub and Holy Terror by Flo Conway and Jim Siegelman for any of you wishing to follow up on the Church/State issues discussed earlier.) Okay. That's it. THE END. It's been a pleasure talking to you -- and don't forget to register to vote. eVersion 3.0 Notes: Proofed carefully against DT, italics intact. This document is abebook.css and nicebook.css compatible. Yes, all of these boldfaces, italics and underlines are really in the book!.Also, as in the DT, sometimes a single quote is used and sometimes a double. ATOUCHSTONE BOOK Published by Simon & Schuster Touchstone Rockefeller Center 1230Avenue of theAmericas New York, NY 10020 Copyright © 1989 by Frank Zappa All rights reserved including the right of reproduction in whole or in part in any form. First Touchstone Edition 1999 TOUCHSTONE and colophon are registered trademarks of Simon & Schuster Inc. Designed byAwest Manufactured in the United States ofAmerica 1 3 5 7 9 10 8 6 4 2 15 17 19 20 18 16 Pbk. Library of Congress Cataloging-in-Publication Data Zappa, Frank. The real Frank Zappa book/Frank Zappa, with Peter Occhiogrosso. p. cm. 1. Zappa, Frank. 2. Rock musicians -- United States -- Biography. I. Occhiogrosso, Peter. II. Title ML410.Z285A3 1989 784.5'4'00924 -- dc19 [B] 89-3470 CIP MN ISBN 0-671-63870-X ISBN 0-671-70572-5 Pbk. PICTURE CREDITS: Gerald Wortman (p. 81); Doug Metzler (p. 100); Cynthia Plaster-Caster (drawing, p.104);\n\n\nQ: What was your biggest problem with school?\n\nA: My biggest problem, throughout school, was that the things they were trying to teach me tended not to be the kinds of things I was interested in. I grew up with poison gas and explosives -- with the children of people who built these things for a living. Did I give a fuck about algebra?\n\n\nQ: Did you read Shakespeare?\n\nA: The epigraphs at the heads of chapters were researched and inserted by Peter -- I mention this because I wouldn't want anybody to think I sat around reading Flaubert, Twitchell and Shakespeare all day.\n\n\nQ: Why did you write an autobiography?\n\nA: One of the reasons for doing this is the proliferation of stupid books (in several languages) which purport to be About Me. I thought there ought to be at least ONE, somewhere, that had real stuff in it. The opportunity to say stuff in print about tangential subjects is appealing.\n\n\nQ: How did teenaged Frank Zappa treat visitors to his house?\n\nA: All through high school, whenever people came over, I would force them to listen to Varèse -- because I thought it was the ultimate test of their intelligence.\n\n\nQ: Should I quit school or go on?\n\nA: I always tell them you should infiltrate. Hurry up and take over your father's job and do it right. It's fortunate that something like Psychedelia and Haight-Ashbury and all the rest of that goes on because it takes the focus off of the possibility that somebody who looks clean, straight, wholesome, right-wing and harmless is going to come in there and just do it while they're not looking. It's a much more frightening concept thinking it's some hairy creep that's going to take over your job. It's not going to be that way, it's going to be some guy who is straight.\n\n\nQ: Is music better or worse than when you started? And I don’t mean your music I mean music in general.\n\nA: Well if you’re talking about the known musical universe - in other words, what you can hear on the radio and what they show you on MTV - it is way worse. But that doesn’t mean that there aren’t good things out there that we don’t know about. It’s just that the broadcasters are not letting us find out about it. Because it’s hard for me to believe that all the sudden with the advent of MTV all good songs ceased to be written, all good bands ceased to be formed. I just don’t think that nature works that way. In some place there’s good musicians and good composers and good tunes all over this country and other countries, we just don’t know about them because the people who determine what you get to see and hear have no taste.\n\n\nQ: Do you enjoy touring?\n\nA: If I had to choose I'd be touring. I like to have something happening where the music is alive, and there's people in it, and some feeling to it. It's so hard to get something that exciting in a studio. I think that anyone that wants to shut himself up in a studio for the rest of his life is missing out. To me, the studio is a useful tool. It's a great place to do certain experimental things. There are a number of things that are feasible in the studio that are impossible on a stage, like overdubbing. But for getting out and 'doing it' you've got to go on the road.\n\n\nQ: Are you a rebel without a cause?\n\nA: Hardly, because my cause is music. I'm interested in ﬁnding out what can be done with different types of musical forms of expression – without any interference. It's very difﬁcult to do in the United States because, unless you can sell it to somebody, you can't keep doing it.,\n\n\nQ: What is the concept of 'the Big Note'?\n\nA: The concept of the Big Note is that everything in the universe is composed basically of vibrations – light is a vibration, sound is a vibration, atoms are composed of vibrations – and all these vibrations just might be harmonics of some incomprehensible fundamental cosmic tone.\n\n\nQ: Would you say that music is your whole life?\n\nA: Yes, just about.\n\n\nQ: What is \"the Real Frank Zappa Book\" about?\n\nA: ",
                :temperature => 0.0,
            }
        )

        expect(answer).to eq(expected_answer)
        expect(context).to eq("\n* FR / EN The Real Frank Zappa Book by Frank Zappa with Peter Occhiogrosso eVersion 3.0 - click for copyright info and scan notes THIS BOOK IS DEDICATED TO GAIL, THE KIDS, STEPHEN HAWKINGAND KO-KO. F.Z. August 23, 1988 06:39:37 Contents INTRODUCTION -- Book? What Book? 1 How WeirdAm I,Anyway? 2 There Goes the Neighborhood 3AnAlternative to College 4Are We Having a Good Time Yet? 5 The Log Cabin
* of manufacturing and deploying \"ethnic chemical weapons\" -- designed to kill people from speciﬁc ethnic backgrounds. On page 241 you will ﬁnd an extract from a 1969 Senate appropriations hearing, with testimony (speaker unidentiﬁed) regarding the development of a new class of biological weapons (note the plural) which would be \"refractory\" to the human immunological system. Whose testimony was this? Was he asking for money to build a few of these diseases? What senators heard this testimony?Are they still in ofﬁce? Did they appropriate any funds? If so, who got them? What did they eventually spend them on? The book doesn't say, but presumably some answers might be found in The Congressional Record. (I also recommend The Mind of the Bible Believer by Edmund Cohen, PhD., Salvation for Sale by Gerard Thomas Straub and Holy Terror by Flo Conway and Jim Siegelman for any of you wishing to follow up on the Church/State issues discussed earlier.) Okay. That's it. THE END. It's been a pleasure talking to you -- and don't forget to register to vote. eVersion 3.0 Notes: Proofed carefully against DT, italics intact. This document is abebook.css and nicebook.css compatible. Yes, all of these boldfaces, italics and underlines are really in the book!.Also, as in the DT, sometimes a single quote is used and sometimes a double. ATOUCHSTONE BOOK Published by Simon & Schuster Touchstone Rockefeller Center 1230Avenue of theAmericas New York, NY 10020 Copyright © 1989 by Frank Zappa All rights reserved including the right of reproduction in whole or in part in any form. First Touchstone Edition 1999 TOUCHSTONE and colophon are registered trademarks of Simon & Schuster Inc. Designed byAwest Manufactured in the United States ofAmerica 1 3 5 7 9 10 8 6 4 2 15 17 19 20 18 16 Pbk. Library of Congress Cataloging-in-Publication Data Zappa, Frank. The real Frank Zappa book/Frank Zappa, with Peter Occhiogrosso. p. cm. 1. Zappa, Frank. 2. Rock musicians -- United States -- Biography. I. Occhiogrosso, Peter. II. Title ML410.Z285A3 1989 784.5'4'00924 -- dc19 [B] 89-3470 CIP MN ISBN 0-671-63870-X ISBN 0-671-70572-5 Pbk. PICTURE CREDITS: Gerald Wortman (p. 81); Doug Metzler (p. 100); Cynthia Plaster-Caster (drawing, p.104);")
    end
end
